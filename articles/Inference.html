<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Inference • bascule</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Inference">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bascule</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/bascule.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Fit_breast_data.html">Fit on real data</a></li>
    <li><a class="dropdown-item" href="../articles/Inference.html">Inference</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Inference</h1>
            
      

      <div class="d-none name"><code>Inference.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/caravagnalab/bascule" class="external-link">bascule</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Loading <span style="color: #00BB00;">bascule</span>. Support : <span style="color: #0000BB; font-style: italic;">&lt;https://caravagnalab.github.io/bascule/&gt;</span></span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html" class="external-link">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>warning <span class="op">=</span> <span class="cn">FALSE</span>, message <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/install_python.html" class="external-link">install_python</a></span><span class="op">(</span>version<span class="op">=</span><span class="st">"3.9.16"</span><span class="op">)</span></span>
<span><span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/py_install.html" class="external-link">py_install</a></span><span class="op">(</span>packages<span class="op">=</span><span class="st">"pybascule"</span>, </span>
<span>                       pip<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                       python_version<span class="op">=</span><span class="st">"3.9.16"</span><span class="op">)</span></span>
<span><span class="va">py</span> <span class="op">=</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/import.html" class="external-link">import</a></span><span class="op">(</span><span class="st">"pybascule"</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="load-datasets">Load datasets<a class="anchor" aria-label="anchor" href="#load-datasets"></a>
</h2>
<p>We can load the data <code>example_dataset</code>, a bascule object
containing the true signatures and exposures used to generate the
mutation counts matrix. In the object, data for SBS and DBS is
reported.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"synthetic_data"</span><span class="op">)</span></span></code></pre></div>
<p>We can extract the mutation count matrix from the object using the
<code>get_input</code> function. With <code>reconstructed=FALSE</code>
we are obtaining the observed counts, and not the reconstructed ones
computed as the matrix multiplication of exposures and signatures.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op">=</span> <span class="va">synthetic_data</span><span class="op">$</span><span class="va">counts</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">counts</span><span class="op">[[</span><span class="st">"SBS"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;      A[C&gt;A]A A[C&gt;A]C A[C&gt;A]G A[C&gt;A]T A[C&gt;G]A A[C&gt;G]C A[C&gt;G]G A[C&gt;G]T A[C&gt;T]A</span></span>
<span><span class="co">#&gt; G1_1     118       7       0      52      10       2       1       5      27</span></span>
<span><span class="co">#&gt; G1_2     236      21       5     107      17      12       3      14      67</span></span>
<span><span class="co">#&gt; G1_3     132       8       1      50      11       5       1       7      42</span></span>
<span><span class="co">#&gt; G1_4     116      15       3      40      10       6       0      12      40</span></span>
<span><span class="co">#&gt; G1_5     149      12       3      56      10       3       2      14      49</span></span>
<span><span class="co">#&gt; G1_6     161      10       2      66      13       8       4      13      62</span></span>
<span><span class="co">#&gt;      A[C&gt;T]C</span></span>
<span><span class="co">#&gt; G1_1      10</span></span>
<span><span class="co">#&gt; G1_2      35</span></span>
<span><span class="co">#&gt; G1_3      19</span></span>
<span><span class="co">#&gt; G1_4      26</span></span>
<span><span class="co">#&gt; G1_5      16</span></span>
<span><span class="co">#&gt; G1_6      25</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">counts</span><span class="op">[[</span><span class="st">"DBS"</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;      AC&gt;CA AC&gt;CG AC&gt;CT AC&gt;GA AC&gt;GG AC&gt;GT AC&gt;TA AC&gt;TG AC&gt;TT AT&gt;CA</span></span>
<span><span class="co">#&gt; G1_1     5     1     4     8     4    12     5     0     6    13</span></span>
<span><span class="co">#&gt; G1_2     4     1     6     4     3    17     0     1     3    16</span></span>
<span><span class="co">#&gt; G1_3     5     0     4     6     1    13     1     0     2    18</span></span>
<span><span class="co">#&gt; G1_4     2     0     0     2     0     4     1     1     2     3</span></span>
<span><span class="co">#&gt; G1_5     4     0     4     3     0     6     0     1     2     8</span></span>
<span><span class="co">#&gt; G1_6     0     0     3     1     0     5     0     1     1     1</span></span></code></pre></div>
<p>We use as reference the COSMIC catalogue for SBS and DBS.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reference_cat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"SBS"</span><span class="op">=</span><span class="va">COSMIC_sbs_filt</span>, <span class="st">"DBS"</span><span class="op">=</span><span class="va">COSMIC_dbs</span><span class="op">)</span></span></code></pre></div>
<p>In the example dataset, the true number of signatures (reference plus
de novo) is 5 for both SBS and DBS, thus we can provide as list of K de
novo signatures to test values from 0 to 7.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">K_list</span> <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">7</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fit-the-model">Fit the model<a class="anchor" aria-label="anchor" href="#fit-the-model"></a>
</h2>
<p>Now, we can fit the model. Let’s first fit the NMF to perform
signatures deconvolution.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit.html">fit</a></span><span class="op">(</span>counts<span class="op">=</span><span class="va">counts</span>, k_list<span class="op">=</span><span class="va">K_list</span>, n_steps<span class="op">=</span><span class="fl">3000</span>,</span>
<span>        reference_cat<span class="op">=</span><span class="va">reference_cat</span>,</span>
<span>        keep_sigs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SBS1"</span>,<span class="st">"SBS5"</span><span class="op">)</span>, <span class="co"># force fixed signatures</span></span>
<span>        store_fits<span class="op">=</span><span class="cn">TRUE</span>, </span>
<span>        py<span class="op">=</span><span class="va">py</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="va">synthetic_data</span><span class="op">$</span><span class="va">x</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualize-the-inference-scores">Visualize the inference scores<a class="anchor" aria-label="anchor" href="#visualize-the-inference-scores"></a>
</h2>
<p>You can inspect the model selection procedure. The plot shows for
each tested value of K (i.e., number of de novo signatures), the value
of the BIC and likelihood of the respective model. In our
implementation, the model with lowest BIC is considered as the best
model.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_scores.html">plot_scores</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<p><img src="Inference_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>Another variable of interest is the evolution over the iterations of
the norms of the gradients for each inferred parameter. A good result,
as shown below, is when the norms decreases with inference, reporting an
increased stability.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_gradient_norms.html">plot_gradient_norms</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<p><img src="Inference_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="visualize-the-inferred-parameters">Visualize the inferred parameters<a class="anchor" aria-label="anchor" href="#visualize-the-inferred-parameters"></a>
</h2>
<p>You can visualize the inferred signatures. Here, we notice that from
41 and 20 SBS and DBS signatures, the model only selects 6 and 5
signatures from the catalogue. Moreover, it also infers a denovo
signature from the SBS counts.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_signatures.html">plot_signatures</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<p><img src="Inference_files/figure-html/unnamed-chunk-11-1.png" width="1152"></p>
</div>
<div class="section level2">
<h2 id="post-fit-heuristics-and-clustering">Post fit heuristics and clustering<a class="anchor" aria-label="anchor" href="#post-fit-heuristics-and-clustering"></a>
</h2>
<p>We can notice from the signatures plots a clear similarity between
signature SBSD1 and SBS31. We can compute a linear combination on de
novo signatures to remove those similar to reference ones. On the
refined set of signatures we can run the model to perform clustering of
samples based on exposures.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_refined</span> <span class="op">=</span> <span class="fu"><a href="../reference/refine_denovo_signatures.html">refine_denovo_signatures</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">x_refined_cluster</span> <span class="op">=</span> <span class="fu"><a href="../reference/fit_clustering.html">fit_clustering</a></span><span class="op">(</span><span class="va">x_refined</span>, cluster<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_refined_cluster</span> <span class="op">=</span> <span class="va">synthetic_data</span><span class="op">$</span><span class="va">x_refined_cluster</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualisation-of-the-results">Visualisation of the results<a class="anchor" aria-label="anchor" href="#visualisation-of-the-results"></a>
</h2>
<div class="section level3">
<h3 id="mutational-signatures">Mutational signatures<a class="anchor" aria-label="anchor" href="#mutational-signatures"></a>
</h3>
<p>The post-fit de novo signatures refinement discarded signature SBSD1,
since it showed high similarity with reference signature SBS31.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_signatures.html">plot_signatures</a></span><span class="op">(</span><span class="va">x_refined_cluster</span><span class="op">)</span></span></code></pre></div>
<p><img src="Inference_files/figure-html/unnamed-chunk-14-1.png" width="1152"></p>
</div>
<div class="section level3">
<h3 id="exposures-matrix">Exposures matrix<a class="anchor" aria-label="anchor" href="#exposures-matrix"></a>
</h3>
<p>We can visualise the exposures for each patient divided by final
group assignment. In this case, BASCULE retrieved 3 groups. Each cluster
is characterised by a set of SBS and DBS. For instance, group G0 is the
largest one and is characterised by signatures DBS1, DBS11 and DBS3, and
SBS1, SBS5 and SBS31.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_exposures.html">plot_exposures</a></span><span class="op">(</span><span class="va">x_refined_cluster</span><span class="op">)</span></span></code></pre></div>
<p><img src="Inference_files/figure-html/unnamed-chunk-15-1.png" width="1152"></p>
</div>
<div class="section level3">
<h3 id="clustering-centroids">Clustering centroids<a class="anchor" aria-label="anchor" href="#clustering-centroids"></a>
</h3>
<p>We can also inspect the inferred clustering centroids, reporting for
each cluster an average of the group-specific signatures exposures.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_centroids.html">plot_centroids</a></span><span class="op">(</span><span class="va">x_refined_cluster</span><span class="op">)</span></span></code></pre></div>
<p><img src="Inference_files/figure-html/unnamed-chunk-16-1.png" width="576"></p>
</div>
<div class="section level3">
<h3 id="posterior-probabilities">Posterior probabilities<a class="anchor" aria-label="anchor" href="#posterior-probabilities"></a>
</h3>
<p>We can finally visualise the posterior probabilities for each
sample’s assignment. Each row (samples) of this heatmap sums to 1 and
reports the posterior probabilities for each sample to be assigned to
each cluster (columns).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_posterior_probs.html">plot_posterior_probs</a></span><span class="op">(</span><span class="va">x_refined_cluster</span><span class="op">)</span></span></code></pre></div>
<p><img src="Inference_files/figure-html/unnamed-chunk-17-1.png" width="768"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Elena Buscaroli, Azad Sadr, Giulio Caravagna.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
