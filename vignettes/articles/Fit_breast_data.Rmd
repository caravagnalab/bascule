---
title: "Fit on real data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Fit on real data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Package setup

```{r}
library(bascule)
```

```{r setup, eval=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
configure_environment(envname="bascule-env", use_default=TRUE)
py = reticulate::import("pybascule")
```

# Fit the model

Here, we load the breast tumor type fit object (`breast_data`) from the bascule package, and retrieve the input data (`counts`) from the loaded fit object.

```{r}
data("breast_data")
x = breast_data$x
counts = get_input(x, matrix=TRUE, reconstructed=FALSE)
```

We execute the fit function using the input data (`counts`).

```{r eval=FALSE}
x_pre_refinement = fit(
  counts=counts,
  k_list=0:25,
  cluster=15,
  reference_cat=breast_data$reference_cat,
  n_steps=3000, lr=0.005,
  seed_list=c(19,255,18321,331),
  hyperparameters=list("penalty_scale"=0, "alpha_conc"=alpha_conc),
  store_fits=TRUE,
  py=py, 
  CUDA=TRUE, 
  autoguide=TRUE
  )
```


# De novo signatures refinement

Here, we eliminate all inferred de novo signatures that are explainable with linear combination of the other signatures.

```{r eval=FALSE}
x_refined = refine_denovo_signatures(x_pre_refinement)
```

# Patients clustering

We redo the clustering step (if applicable), using the new set of the signatures and updated exposure matrix.

```{r eval=FALSE}
x = fit_clustering(
  x_pre_refinement,
  cluster=15,
  seed_list=c(19,255,18321,331),
  hyperparameters=list("penalty_scale"=0, "alpha_conc"=alpha_conc),
  store_fits=TRUE,
  py=py, 
  CUDA=TRUE, 
  autoguide=TRUE
)
x = x %>% merge_clusters()
```


# Visualisation of the results

## Mutational signatures

```{r warning=FALSE}
plot_signatures(x)
```

## Exposures matrix

```{r warning=FALSE}
plot_exposures(x)
```

## Clusters centroids

```{r warning=FALSE}
plot_centroids(x)
```


